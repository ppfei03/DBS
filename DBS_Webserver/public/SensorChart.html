<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verlaufskurve - °C</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        h1 {
            color: #333;
        }
        canvas {
            margin-top: 20px;
            max-width: 100%;
            height: calc(100vh - 150px); /* Dynamische Höhe basierend auf Fensterhöhe */
        }
        .buttons {
            margin: 20px 0;
        }
        .button {
            display: inline-block;
            margin: 10px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Temperatur Verlaufskurve (°C)</h1>
    <!-- Buttons -->
    <div class="buttons">
        <a href="index" class="button">Start</a>
        <a href="AlleBoxen" class="button">Boxen</a>
        <a href="AlleSensoren" class="button">Sensoren</a>
        <a href="AlleMeasurements" class="button">Messungen</a>
        <a href="BoxenMap" class="button">Karte</a>
        <a href="SensorChart" class="button">->Sensor Graph<-</a>
    </div>
    <canvas id="temperatureChart"></canvas>

    <script>
        function calculateIQR(values) {
    // Sortiere Werte
    const sorted = [...values].sort((a, b) => a - b);

    // Quartile berechnen
    const q1 = sorted[Math.floor((sorted.length / 4))];
    const q3 = sorted[Math.ceil((sorted.length * (3 / 4))) - 1];
    const iqr = q3 - q1;

    // Wertebereich für Ausreißerbereinigung
    const lowerBound = q1 - 1.5 * iqr;
    const upperBound = q3 + 1.5 * iqr;

    return { lowerBound, upperBound };
}

function removeOutliers(data) {
    const values = data.map(d => parseFloat(d.value));
    const { lowerBound, upperBound } = calculateIQR(values);

    // Werte innerhalb des Bereichs behalten
    return data.filter(d => {
        const value = parseFloat(d.value);
        return value >= lowerBound && value <= upperBound;
    });
}

async function fetchTemperatureData() {
    try {
        const response = await fetch('https://api.philipppfeiffer.de/api/sensor-measurements?unit=°C');
        const data = await response.json();

        if (data.measurements && data.measurements.length > 0) {
            let measurements = data.measurements;

            // Sortiere Messungen nach Zeit
            measurements.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            // Bereinigung der Daten (Entfernen von Ausreißern)
            measurements = removeOutliers(measurements);

            // Extrahiere die Zeitstempel und Werte
            const labels = measurements.map(measurement => new Date(measurement.createdAt).toLocaleString());
            const values = measurements.map(measurement => parseFloat(measurement.value));

            // Diagramm erstellen
            createChart(labels, values);
        } else {
            console.error('Keine Messwerte gefunden.');
            document.body.innerHTML += '<p>Keine Messwerte verfügbar.</p>';
        }
    } catch (err) {
        console.error('Fehler beim Abrufen der API:', err);
        document.body.innerHTML += '<p>Fehler beim Abrufen der Daten.</p>';
    }
}


        function createChart(labels, data) {
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatur (°C)',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw.toFixed(2); // Zwei Nachkommastellen
                                    return `Wert: ${value} °C`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Zeitpunkt'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperatur (°C)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Funktion, um die Canvas-Höhe dynamisch anzupassen
        function adjustCanvasHeight() {
            const canvas = document.getElementById('temperatureChart');
            const headerHeight = document.querySelector('h1').offsetHeight + document.querySelector('.buttons').offsetHeight + 40;
            canvas.style.height = `${window.innerHeight - headerHeight}px`;
        }

        // Initiale Anpassung und auf Änderungen der Fenstergröße reagieren
        window.addEventListener('resize', adjustCanvasHeight);
        window.addEventListener('load', () => {
            adjustCanvasHeight();
            fetchTemperatureData();
        });
    </script>
</body>
</html>
